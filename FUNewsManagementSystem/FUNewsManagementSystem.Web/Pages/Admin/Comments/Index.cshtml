@page
@model FUNewsManagementSystem.Web.Pages.Admin.Comments.IndexModel
@{
    ViewData["Title"] = "Comment Moderation";
}

<div class="row mb-3">
    <div class="col-md-6">
        <h2><i class="fas fa-comments"></i> Comment Moderation</h2>
        <p class="text-muted">Manage and moderate all user comments</p>
    </div>
    <div class="col-md-6 text-end">
        <button class="btn btn-info" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
</div>

<!-- Comments List -->
<div class="card">
    <div class="card-body">
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Total:</strong> @Model.Comments.Count comments found
        </div>

        @if (Model.Comments.Any())
        {
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th width="5%">ID</th>
                            <th width="35%">News Article</th>
                            <th width="15%">User</th>
                            <th width="30%">Comment</th>
                            <th width="10%">Time</th>
                            <th width="5%">Action</th>
                        </tr>
                    </thead>
                    <tbody id="commentsTableBody">
                        @foreach (var comment in Model.Comments)
                        {
                            <tr id="row_@comment.CommentId">
                                <td><strong>@comment.CommentId</strong></td>
                                <td>
                                    <a href="/Details?id=@comment.NewsArticleId" target="_blank" class="text-decoration-none">
                                        <i class="fas fa-newspaper text-primary"></i>
                                        <small>@comment.NewsTitle</small>
                                    </a>
                                    <br />
                                    <small class="text-muted">ID: @comment.NewsArticleId</small>
                                </td>
                                <td>
                                    <i class="fas fa-user text-info"></i> @comment.AccountName
                                    <br />
                                    <small class="text-muted">ID: @comment.AccountId</small>
                                </td>
                                <td>
                                    <div class="comment-content">
                                        @if (comment.Content.Length > 100)
                                        {
                                            <span>@comment.Content.Substring(0, 100)...</span>
                                        }
                                        else
                                        {
                                            <span>@comment.Content</span>
                                        }
                                    </div>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> @comment.TimeAgo
                                        <br />
                                        @comment.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                                    </small>
                                </td>
                                <td>
                                    <button class="btn btn-danger btn-sm"
                                            onclick="confirmDelete(@comment.CommentId, '@comment.AccountId', '@comment.AccountName', '@Html.Raw(comment.Content.Replace("'", "\\'").Replace("\"", "&quot;"))')"
                                            title="Delete Comment">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-triangle"></i> No comments found.
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        async function confirmDelete(commentId, accountId, accountName, content) {
            const truncatedContent = content.length > 50 ? content.substring(0, 50) + '...' : content;

            if (!confirm(`⚠️ DELETE COMMENT CONFIRMATION\n\nAre you sure you want to delete this comment?\n\nUser: ${accountName}\nComment: "${truncatedContent}"\n\nThe user will be notified that their comment was removed by Admin.`)) {
                return;
            }

            showLoading();

            try {
                const response = await fetch(`/Admin/Comments/Index?handler=Delete&id=${commentId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                hideLoading();

                if (result.success) {
                    toastr.success(result.message);

                    // Remove row with animation
                    const row = document.getElementById(`row_${commentId}`);
                    if (row) {
                        row.style.transition = 'opacity 0.5s';
                        row.style.opacity = '0';
                        setTimeout(() => row.remove(), 500);
                    }

                    // Notify via SignalR - send notification to the comment author
                    await window.signalRConnection?.invoke("NotifyCommentDeletedByAdmin",
                        commentId,
                        result.accountId,
                        result.accountName
                    );
                } else {
                    toastr.error(result.message);
                }
            } catch (error) {
                hideLoading();
                toastr.error('An error occurred while deleting the comment');
                console.error(error);
            }
        }
    </script>
}
