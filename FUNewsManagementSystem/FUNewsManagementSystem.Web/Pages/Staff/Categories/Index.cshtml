@page
@model FUNewsManagementSystem.Web.Pages.Staff.Categories.IndexModel
@{
    ViewData["Title"] = "Category Management";
}

<div class="row mb-3">
    <div class="col-md-6">
        <h2><i class="fas fa-folder"></i> Category Management</h2>
        <p class="text-muted"><i class="fas fa-arrows-alt"></i> Drag and drop to reorder categories</p>
    </div>
    <div class="col-md-6 text-end">
        <button type="button" class="btn btn-primary" onclick="openCreateModal()">
            <i class="fas fa-plus"></i> Add New Category
        </button>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-8">
                <input type="text" id="searchInput" class="form-control" placeholder="Search categories..." />
            </div>
            <div class="col-md-2">
                <select id="statusFilter" class="form-select">
                    <option value="">All Status</option>
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-secondary w-100" onclick="searchCategories()">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th width="40px"><i class="fas fa-grip-vertical"></i></th>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Parent Category</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="categoryTableBody">
                    @foreach (var category in Model.Categories)
                    {
                        <tr data-category-id="@category.CategoryId" style="cursor: move;">
                            <td class="drag-handle" style="cursor: grab;">
                                <i class="fas fa-grip-vertical text-muted"></i>
                            </td>
                            <td>@category.CategoryId</td>
                            <td>@category.CategoryName</td>
                            <td>@category.CategoryDesciption</td>
                            <td>@(category.ParentCategoryName ?? "-")</td>
                            <td>
                                @if (category.IsActive)
                                {
                                    <span class="badge bg-success">Active</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Inactive</span>
                                }
                            </td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="openEditModal(@category.CategoryId)">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="confirmDelete(@category.CategoryId, '@category.CategoryName')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal for Create/Edit -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add New Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <input type="hidden" id="categoryId" />

                    <div class="mb-3">
                        <label for="categoryName" class="form-label">Category Name *</label>
                        <input type="text" class="form-control" id="categoryName" required />
                    </div>

                    <div class="mb-3">
                        <label for="categoryDesciption" class="form-label">Description</label>
                        <textarea class="form-control" id="categoryDesciption" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="parentCategoryId" class="form-label">Parent Category</label>
                        <select class="form-select" id="parentCategoryId">
                            <option value="">-- None (Root Category) --</option>
                            @foreach (var parent in Model.ParentCategories)
                            {
                                <option value="@parent.CategoryId">@parent.CategoryName</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isActive" checked />
                        <label class="form-check-label" for="isActive">Active</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCategory()">Save</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- SortableJS for drag-and-drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script>
        let categoryModal;
        let sortable;

        $(document).ready(function() {
            categoryModal = new bootstrap.Modal(document.getElementById('categoryModal'));

            // Initialize SortableJS
            initializeSortable();
        });

        function initializeSortable() {
            const tbody = document.getElementById('categoryTableBody');
            if (!tbody) return;

            sortable = new Sortable(tbody, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'bg-light',
                onEnd: async function(evt) {
                    await updateCategoryOrder();
                }
            });
        }

        async function updateCategoryOrder() {
            const rows = document.querySelectorAll('#categoryTableBody tr');
            const categoryOrders = {};

            rows.forEach((row, index) => {
                const categoryId = parseInt(row.getAttribute('data-category-id'));
                categoryOrders[categoryId] = index;
            });

            try {
                const response = await fetch('/Staff/Categories/Index?handler=UpdateOrders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    },
                    body: JSON.stringify(categoryOrders)
                });

                const result = await response.json();

                if (result.success) {
                    toastr.success('Category order updated!');

                    // Notify other users via SignalR
                    await window.signalRConnection.invoke("NotifyCategoryOrderChanged");
                } else {
                    toastr.error(result.message || 'Failed to update order');
                    location.reload(); // Reload to restore original order
                }
            } catch (error) {
                console.error('Error updating category order:', error);
                toastr.error('An error occurred while updating order');
                location.reload();
            }
        }

        function openCreateModal() {
            $('#modalTitle').text('Add New Category');
            $('#categoryForm')[0].reset();
            $('#categoryId').val('');
            $('#isActive').prop('checked', true);
            categoryModal.show();
        }

        async function openEditModal(id) {
            const response = await fetch(`/Staff/Categories/Get?id=${id}`);
            const category = await response.json();

            $('#modalTitle').text('Edit Category');
            $('#categoryId').val(category.categoryId);
            $('#categoryName').val(category.categoryName);
            $('#categoryDesciption').val(category.categoryDesciption || '');
            $('#parentCategoryId').val(category.parentCategoryId || '');
            $('#isActive').prop('checked', category.isActive);

            categoryModal.show();
        }

        async function saveCategory() {
            const categoryData = {
                categoryId: $('#categoryId').val() || 0,
                categoryName: $('#categoryName').val(),
                categoryDesciption: $('#categoryDesciption').val(),
                parentCategoryId: $('#parentCategoryId').val() || null,
                isActive: $('#isActive').is(':checked')
            };

            if (!categoryData.categoryName) {
                toastr.error('Category name is required');
                return;
            }

            const url = categoryData.categoryId > 0 ? '/Staff/Categories/Update' : '/Staff/Categories/Create';

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(categoryData)
                });

                const result = await response.json();

                if (result.success) {
                    toastr.success(result.message);
                    categoryModal.hide();

                    // Notify via SignalR
                    if (categoryData.categoryId > 0) {
                        await window.signalRConnection.invoke("NotifyCategoryUpdated", categoryData.categoryName);
                    } else {
                        await window.signalRConnection.invoke("NotifyCategoryCreated", categoryData.categoryName);
                    }

                    setTimeout(() => location.reload(), 1000);
                } else {
                    toastr.error(result.message);
                }
            } catch (error) {
                toastr.error('An error occurred while saving the category');
                console.error(error);
            }
        }

        function confirmDelete(id, name) {
            if (confirm(`Are you sure you want to delete category "${name}"?`)) {
                deleteCategory(id, name);
            }
        }

        async function deleteCategory(id, name) {
            try {
                const response = await fetch(`/Staff/Categories/Delete?id=${id}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    toastr.success(result.message);

                    // Notify via SignalR
                    await window.signalRConnection.invoke("NotifyCategoryDeleted", name);

                    setTimeout(() => location.reload(), 1000);
                } else {
                    toastr.error(result.message);
                }
            } catch (error) {
                toastr.error('An error occurred while deleting the category');
                console.error(error);
            }
        }

        async function searchCategories() {
            const searchTerm = $('#searchInput').val();
            const status = $('#statusFilter').val();

            window.location.href = `?searchTerm=${searchTerm}&isActive=${status}`;
        }

        // Real-time refresh functions
        function refreshCategoriesList() {
            location.reload();
        }
        window.refreshCategoriesList = refreshCategoriesList;

        // Listen for category order changes from other users
        if (window.signalRConnection) {
            window.signalRConnection.on("RefreshCategoryOrder", function() {
                toastr.info('Categories reordered by another user');
                setTimeout(() => location.reload(), 1500);
            });
        }
    </script>
}